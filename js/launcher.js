var aliaLauncher=function(D){"use strict";var sn=Object.defineProperty;var on=(D,I,L)=>I in D?sn(D,I,{enumerable:!0,configurable:!0,writable:!0,value:L}):D[I]=L;var S=(D,I,L)=>on(D,typeof I!="symbol"?I+"":I,L);function I(e,t){throw new Error(`Unhandled discriminated union member: ${JSON.stringify(e)}`)}const L="x-alia-jwt",Ne="x-alia-shop",be="x-alia-shopify-customer-id",Me="x-alia-preview-key",Ue="ALIA_NO_EVAL",Fe={Africa:["AO","BF","BI","BJ","BW","CD","CF","CG","CI","CM","CV","DJ","DZ","EG","EH","ER","ET","GA","GH","GM","GN","GQ","GW","IO","KE","KM","LR","LS","LY","MA","MG","ML","MR","MU","MW","MZ","NA","NE","NG","RE","RW","SC","SD","SL","SN","SO","SS","ST","SZ","TD","TG","TN","TZ","UG","YT","ZA","ZM","ZW"],Antarctica:["AQ","BV","GS","HM","TF"],Asia:["AF","AE","AM","AZ","BD","BH","BN","BT","CN","CY","GE","HK","ID","IL","IN","IQ","IR","JP","JO","KH","KG","KP","KR","KW","KZ","LA","LB","LK","MN","MO","MM","MV","MY","NP","OM","PH","PK","PS","QA","RU","SA","SG","SY","TH","TJ","TL","TM","TR","TW","UZ","VN","YE"],Europe:["AD","AL","AT","AX","BA","BE","BG","BY","CH","CZ","DE","DK","EE","ES","FI","FO","FR","GB","GG","GI","GR","HR","HU","IE","IM","IS","IT","JE","LI","LT","LU","LV","MC","MD","ME","MK","MT","NL","NO","PL","PT","RO","RS","RU","SE","SI","SJ","SK","SM","TR","UA","VA","XK"],"North America":["AG","AI","AW","BB","BL","BM","BQ","BS","BZ","CA","CR","CU","CW","DM","DO","GD","GL","GP","GT","HN","HT","JM","KN","KY","LC","MF","MQ","MS","MX","NI","PA","PM","PR","SV","SX","TC","TT","US","VC","VG","VI"],Oceania:["AS","AU","CC","CK","CX","FJ","FM","GU","KI","MH","MP","NC","NF","NR","NU","NZ","PF","PG","PN","PW","SB","TK","TO","TV","UM","VU","WF","WS"],"South America":["AR","BO","BR","CL","CO","EC","FK","GF","GY","PE","PY","SR","UY","VE"]},Be=["AT","BE","BG","HR","CH","CY","CZ","DK","EE","FI","FR","DE","GB","GR","HU","IE","IS","IT","LI","LV","LT","LU","MT","NO","NL","PL","PT","RO","SK","SI","ES","SE"],Ge="_allEUCountries";function Ke(e){return e===Ge}function ee(e){return e.flatMap(t=>Ke(t)?Be:[t])}function Ve(e){if(e.length===0)return[];const t=new Set;for(const n of e){const r=Fe[n];r&&r.forEach(s=>t.add(s))}return Array.from(t)}function $e(e,t){return new RegExp("^"+e.replace(/([.?+^$[\]\\(){}|/-])/g,"\\$1").replace(/\*/g,".*")+"$").test(t)}const te=e=>e==="local"?localStorage:sessionStorage;function _(e,t){try{const r=te(e).getItem(t);if(!r||r==="undefined")return null;const s=JSON.parse(r);return s==="undefined"?null:s??null}catch(n){return console.error(`Error getting ${t} from ${e}Storage:`,n),null}}function G(e,t,n){try{te(e).setItem(t,JSON.stringify(n))}catch(r){console.error(`Error setting ${t} in ${e}Storage:`,r)}}function M(e){return typeof e=="string"?e:e instanceof Error?e.message:typeof e=="object"&&e!==null&&"error"in e&&typeof e.error=="string"?e.error:"An unknown error occurred"}function Y(e){try{return new URL(e)}catch{return}}async function O(e){return new Promise(t=>setTimeout(t,e))}async function ne(e,t){return Promise.race([O(e),t()])}const C=()=>document;function w(e){return window[e]}function U(e,t){window[e]=t}const re="ALIA_DISABLE_ANALYTICS_TRACKING";function He(){U(re,!0)}function We(){return w(re)}function Ye(){try{const e=w("ALIA_PROFILE_PROPERTIES");return e&&typeof e=="object"&&!Array.isArray(e)?Object.fromEntries(Object.entries(e).filter(([,t])=>t!=null).map(([t,n])=>[t,String(n)])):void 0}catch{return}}function Je(e){const t=Ye();t&&(e={...t,...e}),U("ALIA_PROFILE_PROPERTIES",e)}function je(e){const t=u(e)?e:[],n=new Map;function r(...a){var c;t.push(...a);for(const v of a)(c=n.get(v.type))==null||c.forEach(y=>y(v))}function s({type:a,callback:c,retroactive:v=!1}){const y=c,A=n.get(a)??[];return A.push(y),n.set(a,A),v&&t.filter(T=>T.type===a).forEach(y),()=>{n.set(a,A.filter(P=>P!==c))}}function i(a){r({type:"open",triggerID:a})}function o(){r({type:"close"})}return s({type:"disableAnalyticsTracking",callback:()=>He(),retroactive:!0}),s({type:"setProperties",callback:({properties:a})=>Je(a),retroactive:!0}),{push:r,listen:s,open:i,close:o};function l(a){return typeof a=="object"&&a!==null&&"type"in a&&typeof a.type=="string"}function u(a){return Array.isArray(a)&&a.every(l)}}const Ze="alia:";function xe(e){const t=Ze+e.type,n=new CustomEvent(t,{detail:e});C().dispatchEvent(n)}async function Xe(e){return new Promise((t,n)=>{const r=C().createElement("script");r.src=e,r.async=!0,r.onload=()=>t(r),r.onerror=()=>n(new Error("Failed to load Alia script")),C().head.appendChild(r)})}class Qe{constructor(){S(this,"debugExtensionEnabled",!1);S(this,"appName","launcher");window.postMessage({type:"alia:loaded"},"*"),window.addEventListener("message",t=>{t.data&&t.data.type==="alia:debug_extension_enabled"&&(this.debugExtensionEnabled=!0)})}log(...t){console.log(`[Alia ${this.appName}]`,...t)}debug(...t){this.debugExtensionEnabled&&console.log(`%c[Alia ${this.appName} debug]`,"color: cyan",...t)}error(...t){console.error(`[Alia ${this.appName}]`,...t)}}const p=new Qe;function se(e){try{e()}catch(t){p.error(t)}}const ie="alia_user";function oe(e,t){return e.searchParams.set(ie,encodeURIComponent(t)),e}function qe(e){const t=e.searchParams.get(ie);if(t)return decodeURIComponent(t)}function ae({onLinkClick:e,onHistoryChange:t}){C().addEventListener("click",s=>{if(s.target instanceof HTMLElement){const i=s.target.closest("a");i&&(e==null||e(i))}});const n=history.pushState;history.pushState=function(s,i,o){let l;try{l=t==null?void 0:t(o)}catch(u){p.debug("Error intercepting navigation",u)}return n.call(this,s,i,l??o)};const r=history.replaceState;history.replaceState=function(s,i,o){let l;try{l=t==null?void 0:t(o)}catch(u){p.debug("Error intercepting navigation",u)}return r.call(this,s,i,l??o)}}const ue="alia-jwt";async function R({method:e,path:t,args:n,headers:r,keepAlive:s}){var y;const i=e!=="GET"&&"body"in n,o=et(),{key:l}=N(),u=(y=F())==null?void 0:y.customerID,a=await fetch(v(t,"params"in n&&n.params,"query"in n&&n.query),{method:e,keepalive:s,headers:{...i?{"Content-Type":"application/json"}:{},[Ne]:W(),...o?{[L]:o}:{},...l?{[Me]:l}:{},...u?{[be]:u}:{},...r},...i?{body:JSON.stringify("body"in n?n.body:void 0)}:{}});if(a.status===204)return;const c=await a.json();if(a.ok)return c;throw typeof c!="object"||c==null?new Error("An unknown error occurred"):"error"in c&&typeof c.error=="string"?new Error(c.error):new Error("An unknown error occurred");function v(A,P,T){const k=new URL("https://backend.alia-prod.com");for(const[B,b]of Object.entries(P))A=A.replace(`:${B}`,String(b));k.pathname=`/launcher${A}`;for(const[B,b]of Object.entries(T))b!=null&&k.searchParams.set(B,String(b));return k.toString()}}const ze=(()=>{const e={};return{setItem:(t,n)=>{e[t]=n},getItem:t=>e[t]}})();function ce(){const e=[sessionStorage,ze];return N().key||e.unshift(localStorage),e}function le(e){for(const t of ce())try{t.setItem(ue,e)}catch{}}function et(){for(const e of ce())try{const t=e.getItem(ue);if(t)return t}catch{}return null}function N(){const e="alia_preview_key",t=new URLSearchParams(window.location.search),n=t.get("alia_preview_key");n&&sessionStorage.setItem(e,n);const r=t.get("flow_id"),s=r?parseInt(r):void 0;return{key:sessionStorage.getItem(e),flowID:Number.isNaN(s)?void 0:s}}function J(){return N().key?"session":"local"}function tt(){se(()=>{const e=new URL(window.location.href),t=qe(e);return t&&le(t),null})}function nt(e,t){se(()=>{const n=[(t==null?void 0:t.primaryDomain)??"",...(t==null?void 0:t.otherDomains)??[]].filter(s=>!!s);if(n.length<=1)return;const r=n.map(s=>new URL(s)).filter(s=>s.hostname!==window.location.hostname);ae({onLinkClick:s=>{r.some(i=>i.hostname===s.hostname)&&(s.href=oe(new URL(s.href),e).toString())},onHistoryChange:s=>{if(s)return oe(new URL(s),e).toString()}})})}function j(e){return R({method:"POST",path:"/errors",args:{body:e}})}async function rt(e){return await R({method:"POST",path:"/user-flows",args:{body:e}})}async function st(e){return await R({method:"POST",path:"/user-flows/preview",args:{body:e}})}async function it(e){return await R({method:"POST",path:"/users",args:{query:e}})}async function ot(e){return await R({method:"POST",path:"/user-actions",args:{body:e}})}const Z="alia-user-actions";function at(e){const t=[...e],n=_(J(),Z)??[];for(const r of n)r.id&&t.some(s=>s.id===r.id)||t.push(r);return t}class ut{constructor(t){S(this,"mediator");S(this,"actionsBuffer",[]);S(this,"isBuffering",!1);this.mediator=t,window.addEventListener("pageshow",()=>{this.loadFromStorage()})}setActions(t){const n=this.mediator.update(r=>({...r,actions:t(r.actions)}));G(J(),Z,n.actions)}loadFromStorage(){const t=_(J(),Z);t&&this.setActions(()=>[...t])}addActions(...t){this.setActions(n=>[...n,...t])}updateByCreatedAt(t,n){this.setActions(r=>r.map(s=>s.createdAt===t&&s.type===n.type?n:s))}async createAction(t){try{const n=new Date().toISOString();this.addActions({...t,type:t.data.type,createdAt:n}),this.isBuffering?this.actionsBuffer.push({...t,createdAt:n}):await this.publishAction({...t,createdAt:n})}catch(n){j({message:`Failed to create ${t.data.type} user action`,data:{action:t,error:M(n)}})}}async publishAction(t){const n=await ot(t);this.updateByCreatedAt(t.createdAt,n)}bufferUserActions(t){this.isBuffering=!0,setTimeout(()=>{this.flushUserActions()},t)}async flushUserActions(){this.isBuffering=!1;const t=[...this.actionsBuffer];this.actionsBuffer.length=0;for(const n of t)await this.publishAction(n)}}class ct{constructor(t){S(this,"state");S(this,"subscriptions",[]);S(this,"userActionsStore");this.state=t,this.userActionsStore=new ut(this)}update(t){return this.state={...this.state,...t(this.state)},this.subscriptions.forEach(n=>n(this.state)),this.state}subscribe(t){return this.subscriptions.push(t),()=>{this.subscriptions=this.subscriptions.filter(n=>n!==t)}}}let K;window.addEventListener("message",e=>{e.data&&e.data.type==="alia:user_overrides"&&(K=e.data.overrides)});function lt(){try{if(!K||typeof K!="object")return;const e=K,t=r=>r in e?e[r]:void 0,n=r=>typeof r=="string"?r:void 0;return{country:n(t("country")),market:n(t("market")),language:n(t("language")),ipCountry:n(t("ipCountry")),ipRegion:n(t("ipRegion")),ipCity:n(t("ipCity"))}}catch(e){p.error("Failed to get overrides",e);return}}function x(e){return`alia-session${e?`-${e}`:""}`}function fe(e=null){return _("session",x(e))??{start:Date.now(),isEngaged:!1}}class ft{constructor(t,n){S(this,"isNewSession");S(this,"flowID",null);S(this,"onEngaged",null);this.flowID=t??null,this.onEngaged=n??null,this.setupEngagedListeners(),_("session",x(this.flowID))?this.isNewSession=!1:(this.isNewSession=!0,this.setValue({start:Date.now(),isEngaged:!1}))}getValue(){return fe(this.flowID)}setValue(t){G("session",x(this.flowID),t)}setupEngagedListeners(){ae({onLinkClick:t=>{t.href&&t.hostname===window.location.hostname&&this.handleEngagedSession()},onHistoryChange:()=>{this.handleEngagedSession()}})}handleNewSession(){this.isNewSession}handleEngagedSession(){var n;const t=this.getValue();t.isEngaged||(this.setValue({...t,isEngaged:!0}),(n=this.onEngaged)==null||n.call(this))}}async function de(e){We()||await R({method:"POST",path:"/events/v2",args:{body:e},keepAlive:!0})}const ge="alia-session-record";function dt(){const e=_("session",ge);if(e!==null)return e;const t=Math.random()<.2;return G("session",ge,t),t}class pe{constructor(t){S(this,"tracker");S(this,"flowID",null);S(this,"shouldRecord");this.flowID=t??null,this.shouldRecord=dt(),this.tracker=new ft(t,()=>{de({flowID:this.flowID,type:"engagedSession",shouldRecordV2:this.shouldRecord})})}handleNewSession(){this.tracker.isNewSession&&de({flowID:this.flowID,type:"session",shouldRecordV2:this.shouldRecord})}}const gt=Symbol("NO_EVAL");function pt(e,t=!1){try{return ht(e,t)}catch(n){return p.error("Error executing code",{code:e,error:M(n)}),null}}function yt(){return w(gt)===!0||w(Ue)===!0}function ht(e,t=!1){return!t&&yt()?void 0:new Function(e)()}async function mt(e){return await R({method:"GET",path:"/integrations/klaviyo-oauth/lists",args:{query:e}})}async function wt(e){return await R({method:"GET",path:"/integrations/klaviyo-oauth/segments",args:{query:e}})}async function St(e){const t=await we("klaviyo");return t==="skip"||e.type==="klaviyo.identified"?t:!t}async function vt(){try{const{klaviyo:t}=await e(),n=await ne(1e3,async()=>await(t==null?void 0:t.isIdentified()));return n===void 0?void 0:n===!0}catch{return}async function e(){try{if(!Array.from(C().scripts).find(s=>s.src.includes("klaviyo.js")))return{klaviyo:void 0};const n=()=>w("klaviyo");return n()?{klaviyo:n()}:await ne(1e3,async()=>await new Promise(s=>{const i=setInterval(()=>{n()&&(s({klaviyo:n()}),clearInterval(i))},100)}))??{klaviyo:void 0}}catch{return{klaviyo:void 0}}}}async function At(e){if(!e.listID)return!0;const t=e.listID,n=await Et();return(n==null?void 0:n.includes(t))??e.fallback?e.type==="klaviyo.inList":e.type==="klaviyo.notInList"}async function It(e){if(!e.segmentID)return!0;const t=e.segmentID,n=await Dt();return(n==null?void 0:n.includes(t))??e.fallback?e.type==="klaviyo.inSegment":e.type==="klaviyo.notInSegment"}let V;async function Et(){try{if(V)return await V;const e=ye();return e?(V=Promise.race([mt({exchangeID:e}),O(2e3)]),await V):void 0}catch(e){p.error(e);return}}let $;async function Dt(){try{if($)return await $;const e=ye();return e?($=Promise.race([wt({exchangeID:e}),O(2e3)]),await $):void 0}catch(e){p.error(e);return}}function ye(){const t=s(C().cookie).__kla_id;if(!t)return;const n=JSON.parse(atob(t));if(!n||typeof n!="object")return;const r=Object.hasOwn(n,"$exchange_id")?n.$exchange_id:void 0;if(typeof r!="string")return;return r;function s(i){const o=i.split(";"),l={};for(let u=0;u<o.length;u++){const c=o[u].trim().split("=");if(c.length>1){const v=c[0],y=decodeURIComponent(c.slice(1).join("="));l[v]=y}}return l}}async function Ct(e,t){var s,i,o,l;if(t.evaluated.includes(e.resource.id))return"skip";const n=e.resource.type==="targetingRule"?(i=(s=t.targetingRules)==null?void 0:s.rules.find(u=>u.id===e.resource.id))==null?void 0:i.config:(l=(o=t.segments.find(u=>u.id===e.resource.id))==null?void 0:o.targeting)==null?void 0:l.rule;if(!n)return"skip";const r=await Q(n,{...t,evaluated:[...t.evaluated,e.resource.id]});return r!=="skip"?e.type==="inTargetingRule"?r:!r:e.resource.type==="segment"&&e.type==="notInTargetingRule"?!1:"skip"}async function Rt(e,t){return await Promise.race([pt(`return (async ({ campaignID, profile: { user, actions } }) => { ${e.code} 
 })(${JSON.stringify({campaignID:t.segmentID,profile:t})})`),O(1e3)])===!0}const he={klaviyo:async()=>await vt(),smsbump:async()=>{var e,t;return(t=(e=w("smsbump"))==null?void 0:e.isIdentified)==null?void 0:t.call(e)},unveild:async()=>{var e,t;return(t=(e=w("unveild"))==null?void 0:e.checkIfUserIdentified)==null?void 0:t.call(e)},upstack:async()=>{var e,t;return await((t=(e=w("_upsShopifyClient"))==null?void 0:e.isKnown)==null?void 0:t.call(e))},tie:async()=>{if(!Array.isArray(w("dataLayer")))return!1;for(const e of w("dataLayer"))if(e&&e.rrid_response&&Array.isArray(e.rrid_response.results))for(const{columns:t,data:n}of e.rrid_response.results){if(!Array.isArray(t)||!Array.isArray(n))continue;const r=t.indexOf("party_source");if(r!==-1){for(const{row:s}of n)if(Array.isArray(s)&&s[r]===1)return!0}}return!1}},me="alia-cookie-results",H=_("session",me)??{};async function Pt(e){const n=(await Promise.all(Object.keys(he).filter(r=>!e.exclude.includes(r)).map(async r=>await we(r)))).some(r=>r===!0);return e.type==="cookie.identified"?n:!n}async function we(e){try{if(H[e]!==void 0)return H[e];const n=await t();return H[e]=n,G("session",me,H),n}catch{return"skip"}async function t(){const n=await he[e]();return n===!0?!0:n===!1?!1:"skip"}}function X(e,t){switch(e.operator){case"eq":return t===e.value;case"neq":return t!==e.value;case"gt":return t>e.value;case"gte":return t>=e.value;case"lt":return t<e.value;case"lte":return t<=e.value}}function Se(e,t){const n=e.value*s(e.unit),r=Date.now()-t.getTime();switch(e.operator){case"gt":return r>n;case"lt":return r<n}function s(i){let o=1e3;if(i==="seconds"||(o*=60,i==="minutes")||(o*=60,i==="hours")||(o*=24,i==="days"))return o;if(i==="weeks")return o*7;if(o*=30,i==="months"||(o*=12,i==="years"))return o;I(i)}}function Tt(e,{user:t},n){const s=(e.type==="hasNotVisitedPage"||e.type==="hasVisitedPage")&&t.profile.history?t.profile.history.flat().map(u=>Y(u)):[Y(window.location.href)],o=(e.matchType==="exact"?e.values:e.matchType==="contains"?e.values.map(u=>`*${u}*`):I(e.matchType)).some(u=>s.some(a=>a&&l(e.pageType,a,u)));return e.type==="hasVisitedPage"||e.type==="isOnPage"?o:!o;function l(u,a,c){const v=u==="url"?a.toString():u==="path"?a.pathname+a.search+a.hash:I(u);return $e(y(c),y(v));function y(A){return A.replace(/\/$/,"")}}}function kt(e,{user:t}){var r;const n=(r=t.profile.history)==null?void 0:r.at(-1);return n?X(e.value,n.length):!1}function Lt(e,{user:t}){var n;return X(e.value,((n=t.profile.history)==null?void 0:n.length)??0)}async function _t(){const e=w("Shopify");if(!e)return{};const t=new Promise(n=>{e==null||e.loadFeatures([{name:"consent-tracking-api",version:"0.1"}],n)});return await Promise.race([t,O(1e3)]),e.customerPrivacy?{marketingAllowed:e.customerPrivacy.marketingAllowed(),saleOfDataAllowed:e.customerPrivacy.saleOfDataAllowed(),analyticsProcessingAllowed:e.customerPrivacy.analyticsProcessingAllowed(),preferencesProcessingAllowed:e.customerPrivacy.preferencesProcessingAllowed()}:{}}function Ot(e,t){return X(e.value,t.user.shopifyNumOrders??0)}function Nt(e,t){const n=t.user.country;if(n===null)return!0;const r=ee(e.countries).includes(n);return e.type==="shopify.inCountries"?r:!r}function bt(e,t){const n=t.user.market;return n===null?!0:e.type==="shopify.inMarkets"?e.markets.includes(n):!e.markets.includes(n)}function Mt(e,t){const n=t.user.language;return n===null?!0:e.type==="shopify.inLocales"?e.locales.includes(n):!e.locales.includes(n)}async function Ut(e){const{marketingAllowed:t,saleOfDataAllowed:n,analyticsProcessingAllowed:r,preferencesProcessingAllowed:s}=await _t();return e.consentTypes.some(o=>{switch(o){case"marketing":return t;case"saleOfData":return n;case"analyticsProcessing":return r;case"preferencesProcessing":return s}})}function ve(e,t){const n=t.history.flat();for(const r of n.reverse()){const s=Y(r),i=s==null?void 0:s.searchParams.get(e);if(i)return i}return null}function Ft(e,t){const n=ve("utm_source",t.user.profile),r=e.values.includes(n);return e.type==="traffic.utmSourceIsIn"?r:!r}function Bt(e,t){const n=ve("utm_medium",t.user.profile),r=e.values.includes(n);return e.type==="traffic.utmMediumIsIn"?r:!r}function Gt(e,t){return Se(e.value,new Date(t.user.createdAt))}function Kt(e,t){const n=t.user.isMobile;return n===null?!0:e.device==="mobile"?n:!n}function Vt(e,t){const n=t.user.ipCountry;if(n===null)return"skip";const r=ee(e.countries).includes(n);return e.type==="user.inCountries"?r:!r}function $t(e,t){const n=t.user.ipCountry;if(n===null)return"skip";const s=Ve(e.continents).includes(n);return e.type==="user.inContinents"?s:!s}function Ht(e,t){const n=t.user.ipRegion;return n===null?"skip":e.type==="user.inRegions"?e.regions.includes(n):!e.regions.includes(n)}function Wt(e,t){const n=t.user.ipCity,r=t.user.ipRegion;if(n===null||r===null)return"skip";const s=e.cityRegions.some(i=>i.city===n&&i.region===r);return e.type==="user.inCityRegions"?s:!s}function Yt(e,t){const n=t.actions.some(r=>{if(e.action.type==="popupClose"){if(!(r.data.type==="popupClose"||r.data.type==="popupStep"&&r.data.isFloatingButton))return!1}else if(r.data.type!==e.action.type)return!1;return e.thisSession==="exclude"&&new Date(r.createdAt).getTime()>t.sessionStart?!1:e.filters?Jt(r,e.filters):!0});return e.type==="user.hasDoneAction"?!!n:!n}function Jt(e,t){return t.every(s=>{switch(s.type){case"userAction.date":return n(s);case"userAction.inSegments":case"userAction.notInSegments":return r(s)}});function n(s){return Se(s.value,new Date(e.createdAt))}function r(s){const i=s.segmentIDs.some(o=>e.segmentID===o);return s.type==="userAction.inSegments"?i:!i}}async function Ae(e,t){switch(e.type){case"inTargetingRule":case"notInTargetingRule":return Ct(e,t);case"customCode":return await Rt(e,t);case"klaviyo.identified":case"klaviyo.notIdentified":return await St(e);case"klaviyo.inList":case"klaviyo.notInList":return await At(e);case"klaviyo.inSegment":case"klaviyo.notInSegment":return await It(e);case"isOnPage":case"isNotOnPage":case"hasVisitedPage":case"hasNotVisitedPage":return Tt(e,t);case"pages.numPagesViewed":return kt(e,t);case"pages.numSessions":return Lt(e,t);case"shopify.numOrders":return Ot(e,t);case"shopify.inMarkets":case"shopify.notInMarkets":return bt(e,t);case"shopify.inLocales":case"shopify.notInLocales":return Mt(e,t);case"shopify.inCountries":case"shopify.notInCountries":return Nt(e,t);case"user.inCityRegions":case"user.notInCityRegions":return Wt(e,t);case"shopify.customerPrivacyAllowed":return Ut(e);case"user.createdAt":return Gt(e,t);case"user.device":return Kt(e,t);case"user.inCountries":case"user.notInCountries":return Vt(e,t);case"user.inContinents":case"user.notInContinents":return $t(e,t);case"user.inRegions":case"user.notInRegions":return Ht(e,t);case"user.hasDoneAction":case"user.hasNotDoneAction":return Yt(e,t);case"traffic.utmSourceIsIn":case"traffic.utmSourceIsNotIn":return Ft(e,t);case"traffic.utmMediumIsIn":case"traffic.utmMediumIsNotIn":return Bt(e,t);case"cookie.identified":case"cookie.notIdentified":return Pt(e)}}async function Q(e,t){switch(e.type){case"and":return jt(e,t);case"or":return Zt(e,t)}}async function jt(e,t){const n=await Promise.all(e.conds.map(r=>Ae(r,t)));return n.some(r=>r===!1)?!1:n.some(r=>r==="skip")?"skip":!0}async function Zt(e,t){const n=await Promise.all(e.conds.map(r=>Ae(r,t)));return n.some(r=>r===!0)?!0:n.some(r=>r==="skip")?"skip":!1}const Ie=[];async function xt({user:e,actions:t,targetingRules:n,segments:r,integrationUsers:s}){return(await Promise.all(r.map(async o=>{try{return await Q(o.targeting.rule,{user:e,actions:t,integrationUsers:s,evaluated:[],targetingRules:n,segments:r,segmentID:o.id,sessionStart:fe().start})===!1?void 0:o.id}catch(l){if(p.error(l),Ie.includes(o.id))return;j({message:`Error evaluating targeting rule: ${M(l)}`,data:{error:M(l)},bucket:"merchant_error"}),Ie.push(o.id);return}}))).filter(o=>o!==void 0)}const W=()=>"sculptiqueskin.myshopify.com".substring(0);p.log(W());const F=()=>w("ALIA_SHOPIFY_EXTENSION_INFO"),Xt="https://backend.alia-prod.com",Ee="v3.4.1-pulumi",De=5,Qt=1e3;C().readyState!=="loading"?q():C().addEventListener("DOMContentLoaded",()=>{q()},{once:!0});async function q(e=De){const t="ALIA_HAS_INITIALIZED";if(w(t)){p.log("Alia already initialized");return}if(U(t,!0),n()){p.log("Disabled for bot",navigator.userAgent);return}try{await qt()}catch(r){if(e<=0){p.error(`Failed after ${De} tries`),j({message:"Init failed",data:{error:M(r)}});return}else p.error("Init failed, trying again...",r),await O(2e3),q(e-1)}function n(){const r=navigator.userAgent;return["Googlebot","bingbot","facebookexternalhit","Storebot-Google","AmazonProductDiscovery","Petalbot","Pinterestbot","Applebot","Twitterbot","meta-externalads","AdsBot-Google"].some(s=>r.includes(s))}}async function qt(){var Pe,Te,ke,Le;const e=await en();tt();const t=new pe,n=lt(),{jwt:r,disabledReason:s,...i}=await it({path:window.location.pathname+location.search,url:window.location.href,is_mobile:window.innerWidth<1024,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,ip_address:e,user_agent:navigator.userAgent,country:(n==null?void 0:n.country)??((Pe=F())==null?void 0:Pe.country),market:(n==null?void 0:n.market)??((Te=F())==null?void 0:Te.market),language:(n==null?void 0:n.language)??((ke=F())==null?void 0:ke.language),release_tag:Ee,new_session:t.tracker.isNewSession,ip_country:(n==null?void 0:n.ipCountry)??void 0,ip_region:(n==null?void 0:n.ipRegion)??void 0,ip_city:(n==null?void 0:n.ipCity)??void 0});if(le(r),nt(r,(Le=i.merchant)==null?void 0:Le.settings),s){p.debug("Disabled",s);return}t.handleNewSession();let o=!1,l=!1,u,a,c;const v=[],y=[],A=[],P=[];let T;k();async function k(){T&&clearTimeout(T),await B(),!N().flowID&&(T=setTimeout(k,Qt))}async function B(){var Oe;const{flowID:f}=N(),h=new Set;f||((await xt({...i,actions:(c==null?void 0:c.state.actions)??i.actions,user:(c==null?void 0:c.state.user)??i.user,segments:i.segments.filter(E=>!y.includes(E.id))})).forEach(E=>h.add(E)),v.forEach(E=>h.add(E)));const d=Array.from(h).filter(m=>!y.includes(m));o||(f?p.debug("Previewing popup",f):d.length||p.debug("No matching campaigns")),y.push(...d);const g=d.length||f,[_e]=await Promise.all([f?b():zt(d),g?tn():void 0]);o||(u=w("alia"),a=je(u??[]),a.listen({type:"open",callback:({ignoreTargeting:m,campaignID:E})=>{const z=Number(E);m===!0&&!isNaN(z)&&i.segments.some(rn=>rn.id===z)&&(v.push(z),k())},retroactive:!0}),c=new ct({actions:at(i.actions),modalFlowID:nn(_e),user:i.user}));for(const m of _e){if(!((Oe=m.userFlow)!=null&&Oe.flowID)||A.includes(m.userFlow.flowID))continue;A.push(m.userFlow.flowID),xe({type:"campaignMatched",campaignID:m.userFlow.segmentID,campaignTitle:m.userFlow.segmentTitle??void 0,popupID:m.userFlow.flowID,popupTitle:m.userFlow.flowTitle??void 0});const E=C().createElement("div");E.style.position="fixed",C().body.appendChild(E),P.push(window.mountAliaCustomerApp({shop:W(),jwt:r,useShadowDOM:m.settings.useShadowDOM,initialData:m,targetingArgs:i,evaluateTargetingRule:Q,target:E,messages:a,mediator:c}))}o||(o=!0,Re(),U("alia",{unmount:()=>P.forEach(m=>m()),push:a.push,messages:a,open:a.open,close:a.close,mediator:c}))}async function b(){const{flowID:f,key:h}=N();return f?[await st({previewKey:h??"",flowID:f})]:[]}const Ce=new Set;async function zt(f){if(!f.length)return[];const d=(await rt({segmentIDs:f})).filter(({userFlow:g})=>!(g!=null&&g.flowID)||!Ce.has(g.flowID));return d.forEach(({userFlow:g})=>{g!=null&&g.flowID&&Ce.add(g.flowID),g&&p.debug(`Matched campaign ${g.segmentID} (${g.segmentTitle}), serving flow ${g.flowID} (${g.flowTitle})`),new pe(g==null?void 0:g.flowID).handleNewSession()}),d}async function en(){try{const f=await fetch("https://api.ipify.org");return f.status!==200?void 0:await f.text()}catch{return}}async function tn(){l||(await Xe(Xt+`/public/app.js?tag=${encodeURIComponent(Ee)}`),l=!0)}function nn(f){for(const h of f.map(d=>d.userFlow)){const d=h==null?void 0:h.state.steps.at(-1);if((d==null?void 0:d.step)==="popup"&&!(d!=null&&d.floatingButton))return h==null?void 0:h.flowID}}function Re(){try{const f=w("onAliaReady"),h=d=>{typeof d=="function"&&d()};Array.isArray(f)?f.forEach(h):h(f),U("onAliaReady",void 0),setTimeout(Re,1e3)}catch(f){console.error("Error calling executeOnReady",f)}}}return D.SHOP=W,D.shopifyExtensionInfo=F,Object.defineProperty(D,Symbol.toStringTag,{value:"Module"}),D}({});
